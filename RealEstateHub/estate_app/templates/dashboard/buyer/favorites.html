<!-- templates/dashboard/buyer/favorites.html -->
{% extends 'dashboard/buyer/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}My Favorites - BHOOSPARSH Buyer{% endblock %}

{% block extra_css %}
<style>
    /* Favorites page specific styles */
    .favorites-section {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 248, 242, 0.95));
        backdrop-filter: blur(10px);
        border-radius: 16px;
        border: 1px solid rgba(255, 107, 53, 0.1);
        box-shadow: 0 4px 20px rgba(255, 107, 53, 0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .status-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .status-tab {
        padding: 0.625rem 1.5rem;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        background: white;
        color: #4b5563;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-tab:hover {
        border-color: #FF6B35;
        color: #FF6B35;
        transform: translateY(-2px);
    }

    .status-tab.active {
        background: linear-gradient(135deg, #FF6B35, #FF8B5A);
        color: white;
        border-color: #FF6B35;
    }

    .status-tab .count {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .sort-options {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .sort-btn {
        padding: 0.5rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        color: #4b5563;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .sort-btn:hover {
        border-color: #FF6B35;
        color: #FF6B35;
    }

    .sort-btn.active {
        background: linear-gradient(135deg, #FF6B35, #FF8B5A);
        color: white;
        border-color: #FF6B35;
    }

    .favorites-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    .favorite-card {
        background: white;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
        transition: all 0.3s ease;
        height: 100%;
    }

    .favorite-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(255, 107, 53, 0.1), 0 10px 10px -5px rgba(255, 107, 53, 0.04);
        border-color: rgba(255, 107, 53, 0.3);
    }

    .favorite-image-container {
        position: relative;
        height: 220px;
        overflow: hidden;
    }

    .favorite-image-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.6s ease;
    }

    .favorite-card:hover .favorite-image-container img {
        transform: scale(1.1);
    }

    .favorite-actions {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-end;
    }

    .favorite-btn {
        width: 2.5rem;
        height: 2.5rem;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .favorite-btn:hover {
        transform: scale(1.1);
        background: #fef2f2;
    }

    .favorite-btn.active i {
        color: #ef4444;
    }

    .status-dropdown {
        position: relative;
    }

    .status-btn {
        width: 2.5rem;
        height: 2.5rem;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .status-btn:hover {
        transform: scale(1.1);
        background: #f3f4f6;
    }

    .status-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        min-width: 180px;
        z-index: 100;
        display: none;
        overflow: hidden;
    }

    .status-menu.active {
        display: block;
    }

    .status-option {
        padding: 0.75rem 1rem;
        color: #4b5563;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-bottom: 1px solid #f3f4f6;
    }

    .status-option:last-child {
        border-bottom: none;
    }

    .status-option:hover {
        background: #f9fafb;
        color: #FF6B35;
    }

    .favorite-badges {
        position: absolute;
        top: 1rem;
        left: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-weight: 600;
    }

    .badge-featured {
        background: linear-gradient(135deg, #FF6B35, #FF8B5A);
        color: white;
    }

    .badge-urgent {
        background: linear-gradient(135deg, #ef4444, #f87171);
        color: white;
    }

    .badge-verified {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .favorite-content {
        padding: 1.5rem;
    }

    .favorite-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.5rem;
        line-height: 1.4;
    }

    .favorite-location {
        display: flex;
        align-items: center;
        color: #6b7280;
        font-size: 0.875rem;
        margin-bottom: 1rem;
    }

    .favorite-location i {
        margin-right: 0.5rem;
    }

    .favorite-features {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .feature-item {
        text-align: center;
    }

    .feature-value {
        font-size: 1rem;
        font-weight: 700;
        color: #111827;
        display: block;
    }

    .feature-label {
        font-size: 0.75rem;
        color: #6b7280;
        display: block;
    }

    .favorite-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.25rem;
    }

    .price-unit {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .favorite-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e5e7eb;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-interested {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-shortlisted {
        background: #d1fae5;
        color: #065f46;
    }

    .status-view_scheduled {
        background: #fef3c7;
        color: #92400e;
    }

    .status-offered {
        background: #f3e8ff;
        color: #5b21b6;
    }

    .favorite-actions-footer {
        display: flex;
        gap: 0.5rem;
    }

    .action-btn {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .action-btn.view {
        background: #e0f2fe;
        color: #0369a1;
    }

    .action-btn.view:hover {
        background: #bae6fd;
        transform: translateY(-2px);
    }

    .action-btn.compare {
        background: #f0f9ff;
        color: #0c4a6e;
    }

    .action-btn.compare:hover {
        background: #e0f2fe;
        transform: translateY(-2px);
    }

    .action-btn.inquire {
        background: #fef3c7;
        color: #92400e;
    }

    .action-btn.inquire:hover {
        background: #fde68a;
        transform: translateY(-2px);
    }

    .empty-state {
        text-align: center;
        padding: 4rem 1rem;
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        border-radius: 16px;
        border: 2px dashed #d1d5db;
        grid-column: 1 / -1;
    }

    .empty-state i {
        font-size: 1rem;
        color: #9ca3af;
        margin-top: 1rem;
    }

    .empty-state h3 {
        font-size: 1rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #6b7280;
        max-width: 400px;
        font-size: .8rem;
        margin: 0 auto 2rem;
    }
    .empty-state a {
        font-size: .8rem;
    }

    .stats-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        border-color: rgba(255, 107, 53, 0.3);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .loading-skeleton {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    .skeleton-card {
        background: white;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
        height: 450px;
    }

    .skeleton-image {
        height: 220px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    .skeleton-content {
        padding: 1.5rem;
    }

    .skeleton-line {
        height: 1rem;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 4px;
        margin-bottom: 0.75rem;
    }

    .skeleton-line.short {
        width: 60%;
    }

    .skeleton-line.medium {
        width: 80%;
    }

    @keyframes shimmer {
        0% {
            background-position: -200% 0;
        }
        100% {
            background-position: 200% 0;
        }
    }

    /* Mobile Responsive */
    @media (max-width: 767px) {
        .favorites-section {
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .favorites-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .favorite-image-container {
            height: 200px;
        }

        .favorite-content {
            padding: 1rem;
        }

        .favorite-features {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .favorite-footer {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }

        .favorite-actions-footer {
            width: 100%;
            justify-content: space-between;
        }

        .stats-section {
            grid-template-columns: repeat(2, 1fr);
        }

        .status-tabs {
            justify-content: center;
        }
    }

    /* Tablet Responsive */
    @media (min-width: 768px) and (max-width: 1023px) {
        .favorites-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block header_title %}
<h1 class="text-2xl font-bold text-gray-900">
    <span class="gradient-text">My Favorites</span>
</h1>
<p class="text-sm text-gray-600 mt-2">
    <i class="fas fa-heart text-red-500 mr-2"></i>
    Your saved properties and property preferences
</p>
{% endblock %}

{% block header_buttons %}
<div class="flex flex-wrap gap-3">
    <button onclick="window.history.back()" 
            class="px-4 py-2 border-2 border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50 transition-all duration-300 flex items-center gap-2 font-medium">
        <i class="fas fa-arrow-left"></i>
        <span class="hidden sm:inline">Back</span>
    </button>
    
    <a href="{% url 'buyer_properties' %}" 
       class="btn-gradient flex items-center gap-2">
        <i class="fas fa-search"></i>
        <span class="hidden sm:inline">Find More</span>
    </a>
</div>
{% endblock %}

{% block content %}
<div class="content-spacing">
    <!-- Stats Overview -->
    <div class="stats-section">
        <div class="stat-card">
            <div class="stat-value">{{ stats.interested|default:0 }}</div>
            <div class="stat-label">Interested</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-value">{{ stats.shortlisted|default:0 }}</div>
            <div class="stat-label">Shortlisted</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-value">{{ stats.scheduled|default:0 }}</div>
            <div class="stat-label">View Scheduled</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-value">{{ stats.offered|default:0 }}</div>
            <div class="stat-label">Offered</div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="favorites-section">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
            <div>
                <h3 class="text-lg font-bold text-gray-900">Manage Your Favorites</h3>
                <p class="text-sm text-gray-600">Organize and track properties you're interested in</p>
            </div>
            
            <form method="GET" action="{% url 'buyer_favorites' %}" class="flex items-center gap-4">
                <input type="hidden" name="status" value="{{ status_filter }}">
                
                <div class="sort-options">
                    <button type="button" 
                            class="sort-btn {% if sort_by == '-created_at' %}active{% endif %}"
                            onclick="setSort('-created_at')">
                        Newest First
                    </button>
                    <button type="button" 
                            class="sort-btn {% if sort_by == 'created_at' %}active{% endif %}"
                            onclick="setSort('created_at')">
                        Oldest First
                    </button>
                    <button type="button" 
                            class="sort-btn {% if sort_by == '-priority' %}active{% endif %}"
                            onclick="setSort('-priority')">
                        High Priority
                    </button>
                </div>
                
                <input type="hidden" name="sort" id="sortInput" value="{{ sort_by|default:'-created_at' }}">
            </form>
        </div>

        <!-- Status Tabs -->
        <div class="status-tabs">
            <button class="status-tab {% if status_filter == 'all' %}active{% endif %}" 
                    onclick="setStatusFilter('all')">
                <i class="fas fa-layer-group"></i>
                <span>All Properties</span>
                <span class="count">{{ favorites.count }}</span>
            </button>
            
            <button class="status-tab {% if status_filter == 'interested' %}active{% endif %}" 
                    onclick="setStatusFilter('interested')">
                <i class="fas fa-eye"></i>
                <span>Interested</span>
                <span class="count">{{ stats.interested|default:0 }}</span>
            </button>
            
            <button class="status-tab {% if status_filter == 'shortlisted' %}active{% endif %}" 
                    onclick="setStatusFilter('shortlisted')">
                <i class="fas fa-star"></i>
                <span>Shortlisted</span>
                <span class="count">{{ stats.shortlisted|default:0 }}</span>
            </button>
            
            <button class="status-tab {% if status_filter == 'view_scheduled' %}active{% endif %}" 
                    onclick="setStatusFilter('view_scheduled')">
                <i class="fas fa-calendar-alt"></i>
                <span>View Scheduled</span>
                <span class="count">{{ stats.scheduled|default:0 }}</span>
            </button>
            
            <button class="status-tab {% if status_filter == 'offered' %}active{% endif %}" 
                    onclick="setStatusFilter('offered')">
                <i class="fas fa-handshake"></i>
                <span>Offered</span>
                <span class="count">{{ stats.offered|default:0 }}</span>
            </button>
        </div>
    </div>

    <!-- Favorites Grid -->
    {% if favorites %}
    <div class="favorites-grid">
        {% for favorite in favorites %}
        <div class="favorite-card" data-favorite-id="{{ favorite.id }}">
            <div class="favorite-image-container">
                {% if favorite.property.primary_image %}
                <img src="{{ favorite.property.primary_image.url }}" alt="{{ favorite.property.title }}">
                {% else %}
                <div class="w-full h-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center">
                    <i class="fas fa-home text-4xl text-gray-400"></i>
                </div>
                {% endif %}
                
                <div class="favorite-actions">
                    <button class="favorite-btn active" onclick="removeFavorite('{{ favorite.id }}', this)">
                        <i class="fas fa-heart text-red-500"></i>
                    </button>
                    
                    <div class="status-dropdown">
                        <button class="status-btn" onclick="toggleStatusMenu(this)">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        
                        <div class="status-menu">
                            <div class="status-option" onclick="updateFavoriteStatus('{{ favorite.id }}', 'interested')">
                                <i class="fas fa-eye"></i>
                                <span>Interested</span>
                            </div>
                            <div class="status-option" onclick="updateFavoriteStatus('{{ favorite.id }}', 'shortlisted')">
                                <i class="fas fa-star"></i>
                                <span>Shortlisted</span>
                            </div>
                            <div class="status-option" onclick="updateFavoriteStatus('{{ favorite.id }}', 'view_scheduled')">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Schedule View</span>
                            </div>
                            <div class="status-option" onclick="updateFavoriteStatus('{{ favorite.id }}', 'offered')">
                                <i class="fas fa-handshake"></i>
                                <span>Make Offer</span>
                            </div>
                            <div class="status-option" onclick="updateFavoriteStatus('{{ favorite.id }}', 'not_interested')">
                                <i class="fas fa-times"></i>
                                <span>Not Interested</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="favorite-badges">
                    {% if favorite.property.is_featured %}
                    <span class="badge badge-featured">
                        <i class="fas fa-star mr-1"></i> Featured
                    </span>
                    {% endif %}
                    
                    {% if favorite.property.is_urgent %}
                    <span class="badge badge-urgent">
                        <i class="fas fa-bolt mr-1"></i> Urgent
                    </span>
                    {% endif %}
                    
                    {% if favorite.property.is_verified %}
                    <span class="badge badge-verified">
                        <i class="fas fa-check mr-1"></i> Verified
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="favorite-content">
                <h3 class="favorite-title line-clamp-2">{{ favorite.property.title }}</h3>
                
                <div class="favorite-location">
                    <i class="fas fa-map-marker-alt"></i>
                    <span class="line-clamp-1">{{ favorite.property.city }}, {{ favorite.property.state }}</span>
                </div>
                
                <div class="favorite-features">
                    {% if favorite.property.bedrooms %}
                    <div class="feature-item">
                        <span class="feature-value">{{ favorite.property.bedrooms }}</span>
                        <span class="feature-label">Beds</span>
                    </div>
                    {% endif %}
                    
                    {% if favorite.property.bathrooms %}
                    <div class="feature-item">
                        <span class="feature-value">{{ favorite.property.bathrooms }}</span>
                        <span class="feature-label">Baths</span>
                    </div>
                    {% endif %}
                    
                    <div class="feature-item">
                        <span class="feature-value">{{ favorite.property.carpet_area|intcomma }}</span>
                        <span class="feature-label">Sq.ft</span>
                    </div>
                    
                    <div class="feature-item">
                        <span class="feature-value">
                            {% if favorite.property.property_for == 'rent' or favorite.property.property_for == 'pg' %}
                            Rent
                            {% else %}
                            Sale
                            {% endif %}
                        </span>
                        <span class="feature-label">Type</span>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <div>
                        <div class="favorite-price">â‚¹{{ favorite.property.price|intcomma }}</div>
                        {% if favorite.property.property_for in 'rent,pg' %}
                        <div class="price-unit">/month</div>
                        {% endif %}
                    </div>
                    
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-eye mr-1"></i>{{ favorite.property.view_count }}
                    </div>
                </div>
                
                <div class="favorite-footer">
                    <div class="status-indicator status-{{ favorite.status }}">
                        <i class="fas fa-{% if favorite.status == 'interested' %}eye{% elif favorite.status == 'shortlisted' %}star{% elif favorite.status == 'view_scheduled' %}calendar-alt{% elif favorite.status == 'offered' %}handshake{% endif %}"></i>
                        <span>{{ favorite.get_status_display }}</span>
                    </div>
                    
                    <div class="favorite-actions-footer">
                        <a href="{% url 'buyer_property_detail' favorite.property.slug %}" 
                           class="action-btn view" title="View Details">
                            <i class="fas fa-eye"></i>
                        </a>
                        
                        <button class="action-btn compare" 
                                onclick="addToComparison('{{ favorite.property.id }}')"
                                title="Add to Comparison">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        
                        <button class="action-btn inquire" 
                                onclick="openInquiryModal('{{ favorite.property.id }}')"
                                title="Send Inquiry">
                            <i class="fas fa-envelope"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <i class="far fa-heart"></i>
        <h3>No Favorite Properties</h3>
        <p>
            {% if status_filter != 'all' %}
            You don't have any properties in the "{{ status_filter }}" status.
            {% else %}
            You haven't saved any properties yet. Start exploring properties and add them to your favorites!
            {% endif %}
        </p>
        
        <div class="flex flex-wrap gap-3 justify-center mt-6">
            <a href="{% url 'buyer_properties' %}" 
               class="px-6 py-1 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors font-medium flex items-center gap-2">
                <i class="fas fa-search"></i>
                <span>Explore Properties</span>
            </a>
            
            {% if status_filter != 'all' %}
            <button onclick="setStatusFilter('all')" 
                    class="px-6 py-1 border-2 border-blue-600 text-blue-600 rounded-xl hover:bg-blue-600 hover:text-white transition-all duration-300 font-medium flex items-center gap-2">
                <i class="fas fa-layer-group"></i>
                <span>View All Properties</span>
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Status Update Modal -->
<div id="statusUpdateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl w-full max-w-md">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Update Status</h3>
                <button onclick="closeStatusModal()" 
                        class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="hidden">
                    <input type="hidden" id="statusFavoriteId">
                </div>
                
                <div class="status-options grid grid-cols-2 gap-3">
                    <button onclick="selectStatusOption('interested')" 
                            class="status-option-btn p-4 border-2 border-blue-100 rounded-xl text-center hover:bg-blue-50 transition-colors">
                        <i class="fas fa-eye text-2xl text-blue-600 mb-2"></i>
                        <div class="font-semibold text-blue-900">Interested</div>
                        <div class="text-sm text-blue-600">Just looking</div>
                    </button>
                    
                    <button onclick="selectStatusOption('shortlisted')" 
                            class="status-option-btn p-4 border-2 border-green-100 rounded-xl text-center hover:bg-green-50 transition-colors">
                        <i class="fas fa-star text-2xl text-green-600 mb-2"></i>
                        <div class="font-semibold text-green-900">Shortlisted</div>
                        <div class="text-sm text-green-600">Serious interest</div>
                    </button>
                    
                    <button onclick="selectStatusOption('view_scheduled')" 
                            class="status-option-btn p-4 border-2 border-yellow-100 rounded-xl text-center hover:bg-yellow-50 transition-colors">
                        <i class="fas fa-calendar-alt text-2xl text-yellow-600 mb-2"></i>
                        <div class="font-semibold text-yellow-900">View Scheduled</div>
                        <div class="text-sm text-yellow-600">Planning to visit</div>
                    </button>
                    
                    <button onclick="selectStatusOption('offered')" 
                            class="status-option-btn p-4 border-2 border-purple-100 rounded-xl text-center hover:bg-purple-50 transition-colors">
                        <i class="fas fa-handshake text-2xl text-purple-600 mb-2"></i>
                        <div class="font-semibold text-purple-900">Offered</div>
                        <div class="text-sm text-purple-600">Made an offer</div>
                    </button>
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <button onclick="confirmStatusUpdate()" 
                            class="w-full btn-gradient py-3">
                        <i class="fas fa-check mr-2"></i>
                        Update Status
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comparison Modal -->
<div id="comparisonModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl w-full max-w-md">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Add to Comparison</h3>
                <button onclick="closeComparisonModal()" 
                        class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <p class="text-gray-600">Select a comparison list or create a new one:</p>
                
                <div id="comparisonLists" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Comparison lists will be loaded here -->
                </div>
                
                <div class="pt-4 border-t border-gray-200">
                    <button onclick="createNewComparison()" 
                            class="w-full btn-gradient py-3">
                        <i class="fas fa-plus mr-2"></i>
                        Create New Comparison List
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inquiry Modal (shared from properties.html) -->
<div id="inquiryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <!-- Same as in properties.html -->
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize status menus
        initializeStatusMenus();
        
        // Load comparison lists
        loadComparisonLists();
    });

    function setStatusFilter(status) {
        const url = new URL(window.location.href);
        url.searchParams.set('status', status);
        window.location.href = url.toString();
    }

    function setSort(sortValue) {
        const url = new URL(window.location.href);
        url.searchParams.set('sort', sortValue);
        window.location.href = url.toString();
    }

    function toggleStatusMenu(button) {
        const menu = button.parentElement.querySelector('.status-menu');
        menu.classList.toggle('active');
        
        // Close other open menus
        document.querySelectorAll('.status-menu').forEach(otherMenu => {
            if (otherMenu !== menu) {
                otherMenu.classList.remove('active');
            }
        });
    }

    function initializeStatusMenus() {
        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.status-dropdown')) {
                document.querySelectorAll('.status-menu').forEach(menu => {
                    menu.classList.remove('active');
                });
            }
        });
    }

    function updateFavoriteStatus(favoriteId, status) {
        // Close the menu
        document.querySelectorAll('.status-menu').forEach(menu => {
            menu.classList.remove('active');
        });
        
        // Show loading
        showLoading();
        
        fetch('/buyer/ajax/update-favorite-status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                favorite_id: favoriteId,
                status: status
            }),
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                showToast(`Status updated to ${data.new_status}`, 'success');
                
                // Update UI
                const card = document.querySelector(`[data-favorite-id="${favoriteId}"]`);
                if (card) {
                    const indicator = card.querySelector('.status-indicator');
                    if (indicator) {
                        // Update status indicator
                        indicator.className = `status-indicator status-${status}`;
                        const icon = indicator.querySelector('i');
                        const text = indicator.querySelector('span');
                        
                        if (icon && text) {
                            icon.className = `fas fa-${getStatusIcon(status)}`;
                            text.textContent = data.new_status;
                        }
                    }
                }
                
                // Reload page after 1 second to update stats
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast(data.error || 'Failed to update status', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('Network error. Please try again.', 'error');
        });
    }

    function getStatusIcon(status) {
        const icons = {
            'interested': 'eye',
            'shortlisted': 'star',
            'view_scheduled': 'calendar-alt',
            'offered': 'handshake',
            'not_interested': 'times'
        };
        return icons[status] || 'eye';
    }

    function removeFavorite(favoriteId, button) {
        // Show confirmation
        if (!confirm('Are you sure you want to remove this property from favorites?')) {
            return;
        }
        
        // Show loading
        showLoading();
        
        fetch('/buyer/ajax/toggle-favorite/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                favorite_id: favoriteId,
                action: 'remove'
            }),
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                showToast('Property removed from favorites', 'success');
                
                // Remove card from UI
                const card = button.closest('.favorite-card');
                if (card) {
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        card.remove();
                        
                        // If no cards left, reload page
                        if (document.querySelectorAll('.favorite-card').length === 0) {
                            window.location.reload();
                        }
                    }, 300);
                }
            } else {
                showToast(data.error || 'Failed to remove from favorites', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('Network error. Please try again.', 'error');
        });
    }

    function loadComparisonLists() {
        fetch('/buyer/comparisons/json/')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('comparisonLists');
                if (container && data.comparisons) {
                    container.innerHTML = '';
                    
                    data.comparisons.forEach(comparison => {
                        const listItem = document.createElement('div');
                        listItem.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors';
                        listItem.innerHTML = `
                            <div>
                                <div class="font-medium text-gray-900">${comparison.name}</div>
                                <div class="text-sm text-gray-600">${comparison.properties_count} properties</div>
                            </div>
                            <button onclick="addToComparisonList('${comparison.id}')" 
                                    class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                Add
                            </button>
                        `;
                        container.appendChild(listItem);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading comparison lists:', error);
            });
    }

    let selectedPropertyId = null;

    function addToComparison(propertyId) {
        selectedPropertyId = propertyId;
        const modal = document.getElementById('comparisonModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
    }

    function closeComparisonModal() {
        const modal = document.getElementById('comparisonModal');
        modal.classList.remove('flex');
        modal.classList.add('hidden');
        document.body.style.overflow = '';
        selectedPropertyId = null;
    }

    function addToComparisonList(comparisonId) {
        if (!selectedPropertyId) return;
        
        showLoading();
        
        fetch(`/buyer/comparison/${comparisonId}/add/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                property_id: selectedPropertyId
            }),
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                showToast('Property added to comparison list!', 'success');
                closeComparisonModal();
            } else {
                showToast(data.error || 'Failed to add to comparison', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('Network error. Please try again.', 'error');
        });
    }

    function createNewComparison() {
        const name = prompt('Enter name for new comparison list:');
        if (!name) return;
        
        showLoading();
        
        fetch('/buyer/comparisons/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                name: name,
                property_id: selectedPropertyId
            }),
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                showToast('New comparison list created!', 'success');
                closeComparisonModal();
                
                // Reload comparison lists
                loadComparisonLists();
            } else {
                showToast(data.error || 'Failed to create comparison list', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('Network error. Please try again.', 'error');
        });
    }

    // Open/close inquiry modal functions (same as in properties.html)
    function openInquiryModal(propertyId) {
        const modal = document.getElementById('inquiryModal');
        const propertyIdInput = document.getElementById('inquiryPropertyId');
        
        propertyIdInput.value = propertyId;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
    }

    function closeInquiryModal() {
        const modal = document.getElementById('inquiryModal');
        modal.classList.remove('flex');
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }

    function showLoading() {
        // Show loading overlay
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.classList.add('active');
        }
    }

    function hideLoading() {
        // Hide loading overlay
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.classList.remove('active');
        }
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        if (!container) {
            const toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.className = 'toast-container';
            document.body.appendChild(toastContainer);
            container = toastContainer;
        }
        
        const toast = document.createElement('div');
        toast.className = 'toast';
        
        const icons = {
            info: 'fa-info-circle',
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle'
        };
        
        toast.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center flex-shrink-0">
                <i class="fas ${icons[type]}"></i>
            </div>
            <div class="flex-1">
                <span class="font-medium">${message}</span>
            </div>
            <button onclick="this.parentElement.remove()" class="text-white/80 hover:text-white transition-colors flex-shrink-0">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        container.appendChild(toast);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 4000);
    }

    // Utility function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}