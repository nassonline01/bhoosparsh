<!-- Revenue Chart Widget -->
<div class="card h-100">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Revenue Overview</h5>
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                    type="button" 
                    data-bs-toggle="dropdown">
                <span id="chartPeriodLabel">Monthly</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="updateChartPeriod('weekly')">Weekly</a></li>
                <li><a class="dropdown-item" href="#" onclick="updateChartPeriod('monthly')">Monthly</a></li>
                <li><a class="dropdown-item" href="#" onclick="updateChartPeriod('quarterly')">Quarterly</a></li>
                <li><a class="dropdown-item" href="#" onclick="updateChartPeriod('yearly')">Yearly</a></li>
            </ul>
        </div>
    </div>
    <div class="card-body">
        <div class="chart-container" style="height: 250px;">
            <canvas id="revenueChartCanvas"></canvas>
        </div>
        
        <!-- Revenue Summary -->
        <div class="row mt-4 text-center">
            <div class="col-4">
                <div class="text-primary">
                    <i class="fas fa-rupee-sign"></i>
                    <span id="currentRevenue">{{ stats.revenue_stats.total_revenue|default:0|floatformat:0 }}</span>
                </div>
                <small class="text-muted">Total Revenue</small>
            </div>
            <div class="col-4">
                <div class="text-success">
                    <i class="fas fa-arrow-up"></i>
                    <span id="growthRate">12.5%</span>
                </div>
                <small class="text-muted">Growth Rate</small>
            </div>
            <div class="col-4">
                <div class="text-info">
                    <i class="fas fa-exchange-alt"></i>
                    <span id="avgTransaction">{{ stats.revenue_stats.avg_transaction|default:0|floatformat:0 }}</span>
                </div>
                <small class="text-muted">Avg. Transaction</small>
            </div>
        </div>
    </div>
    
    <!-- Revenue Details -->
    <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
                <i class="fas fa-calendar me-1"></i>
                {{ time_period }}
            </small>
            <a href="{% url 'membership:billing_history' %}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-file-invoice-dollar me-1"></i> View Details
            </a>
        </div>
    </div>
</div>

<script>
    // Initialize Revenue Chart
    document.addEventListener('DOMContentLoaded', function() {
        initializeRevenueChart();
    });
    
    function initializeRevenueChart() {
        const ctx = document.getElementById('revenueChartCanvas').getContext('2d');
        
        // Sample data - Replace with actual data from your backend
        const revenueChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'Revenue (₹)',
                    data: [120000, 190000, 300000, 500000, 200000, 300000, 400000, 350000, 450000, 500000, 600000, 700000],
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Revenue: ₹' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
        
        window.revenueChart = revenueChart;
    }
    
    function updateChartPeriod(period) {
        document.getElementById('chartPeriodLabel').textContent = period.charAt(0).toUpperCase() + period.slice(1);
        
        // Update chart data based on period
        // This would typically make an AJAX call to fetch new data
        fetch(`/dashboard/widget/revenue-chart/?period=${period}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && window.revenueChart) {
                    window.revenueChart.data.labels = data.chart_data.labels;
                    window.revenueChart.data.datasets[0].data = data.chart_data.datasets[0].data;
                    window.revenueChart.update();
                    
                    // Update summary values
                    document.getElementById('currentRevenue').textContent = data.current_revenue;
                    document.getElementById('growthRate').textContent = data.growth_rate + '%';
                    document.getElementById('avgTransaction').textContent = data.avg_transaction;
                }
            });
    }
    
    function savePreferences() {
        const form = document.getElementById('preferencesForm');
        const formData = new FormData(form);
        
        fetch('/dashboard/ajax/update-preferences/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Preferences saved successfully!', 'success');
                $('#preferencesModal').modal('hide');
                refreshRecommendations();
            }
        });
    }
    
    function refreshRecommendations() {
        fetch('/dashboard/ajax/refresh-recommendations/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function showToast(message, type) {
        // Toast implementation
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type}`;
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        const container = document.querySelector('.toast-container') || createToastContainer();
        container.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }
    
    function createToastContainer() {
        const container = document.createElement('div');
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(container);
        return container;
    }
</script>