{% extends 'base.html' %}
{% load static %}

{% block title %}Cancel Subscription - RealEstatePro{% endblock %}

{% block extra_css %}
<style>
    .warning-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        margin: 0 auto;
    }
    .reason-option {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .reason-option:hover {
        border-color: #8b5cf6;
        background-color: #f5f3ff;
    }
    .reason-option.selected {
        border-color: #8b5cf6;
        background-color: #f5f3ff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-3xl">
    <!-- Warning Header -->
    <div class="text-center mb-8">
        <div class="warning-icon bg-red-100 text-red-600 mb-4">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h1 class="text-3xl font-bold mb-2">Cancel Subscription</h1>
        <p class="text-gray-600">
            We're sorry to see you go. Please let us know why you're cancelling.
        </p>
    </div>

    <!-- Current Plan Info -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
        <h2 class="text-xl font-bold mb-4">Your Current Plan</h2>
        <div class="flex justify-between items-center">
            <div>
                <div class="text-2xl font-bold">{{ subscription.plan.name }}</div>
                <div class="text-gray-600">
                    {% if subscription.end_date %}
                    Renews on {{ subscription.end_date|date:"F d, Y" }}
                    {% endif %}
                </div>
            </div>
            <div class="text-right">
                <div class="text-2xl font-bold">₹{{ subscription.plan.monthly_price|floatformat:0 }}</div>
                <div class="text-gray-600">per month</div>
            </div>
        </div>
    </div>

    <!-- Cancellation Form -->
    <form method="post" id="cancellationForm">
        {% csrf_token %}
        
        <!-- Cancellation Reasons -->
        <div class="bg-white rounded-xl shadow p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">Why are you cancelling?</h2>
            <p class="text-gray-600 mb-6">Your feedback helps us improve our service.</p>
            
            <div class="space-y-3 mb-6">
                {% for value, label in form.cancel_reason.field.choices %}
                {% if value %}
                <label class="reason-option block p-4" onclick="selectReason('{{ value }}')">
                    <div class="flex items-center justify-between">
                        <div class="font-medium">{{ label }}</div>
                        <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center">
                            <div class="w-3 h-3 rounded-full bg-purple-600 hidden"></div>
                        </div>
                    </div>
                    <input type="radio" name="cancel_reason" value="{{ value }}" 
                           class="hidden" {% if forloop.first %}checked{% endif %}>
                </label>
                {% endif %}
                {% endfor %}
            </div>
            
            <!-- Other Reason -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Other reason (please specify)
                </label>
                <textarea name="cancel_reason_other" 
                          rows="3" 
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          placeholder="Please tell us more about why you're cancelling..."></textarea>
            </div>
            
            <!-- Feedback -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Feedback (optional)
                </label>
                <textarea name="feedback" 
                          rows="4" 
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          placeholder="Any suggestions to help us improve?"></textarea>
            </div>
        </div>

        <!-- Cancellation Options -->
        <div class="bg-white rounded-xl shadow p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">Cancellation Options</h2>
            
            <div class="space-y-4">
                <label class="flex items-start">
                    <input type="radio" name="cancel_option" value="end_of_period" 
                           class="mt-1 mr-3 w-5 h-5 text-purple-600 focus:ring-purple-500" checked>
                    <div>
                        <div class="font-medium">Cancel at end of billing period</div>
                        <div class="text-sm text-gray-600 mt-1">
                            Continue using your current plan until {{ subscription.end_date|date:"F d, Y" }}. 
                            You won't be charged again.
                        </div>
                    </div>
                </label>
                
                <label class="flex items-start">
                    <input type="radio" name="cancel_option" value="immediate" 
                           class="mt-1 mr-3 w-5 h-5 text-purple-600 focus:ring-purple-500">
                    <div>
                        <div class="font-medium">Cancel immediately</div>
                        <div class="text-sm text-gray-600 mt-1">
                            Your subscription ends immediately. You'll receive a prorated refund for unused time.
                        </div>
                    </div>
                </label>
            </div>
            
            <!-- Refund Notice -->
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                    <div class="text-sm">
                        <div class="font-semibold text-blue-800 mb-1">Refund Information</div>
                        <div class="text-blue-700">
                            If you choose immediate cancellation, you'll receive a prorated refund 
                            for the unused portion of your subscription within 5-7 business days.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Before You Go -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 mb-8">
            <div class="flex items-start">
                <i class="fas fa-lightbulb text-yellow-600 text-xl mt-1 mr-4"></i>
                <div>
                    <h3 class="font-bold text-lg mb-2">Before you go...</h3>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span>Downgrade to a lower plan instead</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span>Pause your subscription for a few months</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span>Contact support for assistance with any issues</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex space-x-4">
                        <a href="{% url 'membership:dashboard' %}" 
                           class="px-4 py-2 border border-yellow-600 text-yellow-700 rounded-lg hover:bg-yellow-100 transition">
                            Back to Dashboard
                        </a>
                        <a href="{% url 'membership:pricing' %}" 
                           class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition">
                            View Other Plans
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Final Confirmation -->
        <div class="bg-red-50 border border-red-200 rounded-xl p-6 mb-8">
            <div class="flex items-start mb-4">
                <i class="fas fa-exclamation-circle text-red-600 text-xl mt-1 mr-4"></i>
                <div>
                    <h3 class="font-bold text-lg mb-2">Important Notes</h3>
                    <ul class="space-y-2 text-red-700">
                        <li>• Your listings will become inactive after cancellation</li>
                        <li>• You'll lose access to premium features immediately</li>
                        <li>• Your data will be preserved for 30 days</li>
                        <li>• You can reactivate your subscription anytime</li>
                    </ul>
                </div>
            </div>
            
            <label class="flex items-start">
                <input type="checkbox" name="confirm_cancellation" required
                       class="mt-1 mr-3 w-5 h-5 rounded border-gray-300 text-red-600 focus:ring-red-500">
                <span class="text-gray-700">
                    I understand that my subscription will be cancelled and I'll lose access to premium features.
                    I also understand that I won't be able to create new listings.
                </span>
            </label>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between items-center">
            <a href="{% url 'membership:dashboard' %}" class="text-gray-600 hover:text-gray-800">
                <i class="fas fa-arrow-left mr-2"></i> Keep My Subscription
            </a>
            <div class="space-x-4">
                <button type="button" onclick="confirmCancellation()" 
                        class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">
                    <i class="fas fa-times mr-2"></i> Cancel Subscription
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation text-red-600 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold mb-2">Confirm Cancellation</h3>
            <p class="text-gray-600 mb-4">Are you sure you want to cancel your subscription?</p>
            
            <div class="text-left bg-gray-50 p-4 rounded-lg mb-6">
                <div class="font-medium mb-2">Summary:</div>
                <div class="text-sm text-gray-600">
                    <div>Plan: {{ subscription.plan.name }}</div>
                    <div>Option: <span id="modal-option">End of billing period</span></div>
                    <div>Effective: <span id="modal-date">{{ subscription.end_date|date:"F d, Y" }}</span></div>
                </div>
            </div>
        </div>
        
        <div class="flex justify-center space-x-4">
            <button onclick="closeConfirmModal()" 
                    class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                Go Back
            </button>
            <button onclick="submitCancellation()" 
                    class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                Yes, Cancel Subscription
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedReason = '';
    
    function selectReason(reason) {
        selectedReason = reason;
        
        // Update UI
        document.querySelectorAll('.reason-option').forEach(option => {
            option.classList.remove('selected');
            const radio = option.querySelector('input[type="radio"]');
            if (radio && radio.value === reason) {
                option.classList.add('selected');
                radio.checked = true;
                option.querySelector('.bg-purple-600').classList.remove('hidden');
            } else {
                option.querySelector('.bg-purple-600').classList.add('hidden');
            }
        });
    }
    
    function confirmCancellation() {
        // Validate form
        const form = document.getElementById('cancellationForm');
        const confirmCheck = form.querySelector('[name="confirm_cancellation"]');
        
        if (!confirmCheck.checked) {
            alert('Please confirm that you understand the consequences of cancellation.');
            return;
        }
        
        // Get cancellation option
        const cancelOption = form.querySelector('input[name="cancel_option"]:checked').value;
        const optionText = cancelOption === 'end_of_period' ? 'End of billing period' : 'Immediately';
        const dateText = cancelOption === 'end_of_period' ? 
            '{{ subscription.end_date|date:"F d, Y" }}' : 'Immediately';
        
        // Update modal
        document.getElementById('modal-option').textContent = optionText;
        document.getElementById('modal-date').textContent = dateText;
        
        // Show modal
        document.getElementById('confirmModal').classList.remove('hidden');
    }
    
    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.add('hidden');
    }
    
    function submitCancellation() {
        document.getElementById('cancellationForm').submit();
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Select first reason by default
        const firstReason = document.querySelector('input[name="cancel_reason"]:checked');
        if (firstReason) {
            selectReason(firstReason.value);
        }
        
        // Add click handlers to reason options
        document.querySelectorAll('.reason-option').forEach(option => {
            option.addEventListener('click', function(e) {
                if (e.target.type !== 'radio') {
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = true;
                        selectReason(radio.value);
                    }
                }
            });
        });
        
        // Prevent accidental closing
        let formChanged = false;
        document.getElementById('cancellationForm').addEventListener('change', function() {
            formChanged = true;
        });
        
        window.addEventListener('beforeunload', function(e) {
            if (formChanged) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            }
        });
    });
</script>
{% endblock %}