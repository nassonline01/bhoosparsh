{% extends 'dashboard/buyer/base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}{{ property.title }} - BHOOSPARSH Buyer{% endblock %}

{% block extra_css %}
<style>
    /* Property Detail Page Styles */
    .property-detail-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Image Gallery */
    .property-gallery {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
    }

    .main-image-container {
        position: relative;
        height: 400px;
        overflow: hidden;
        border-radius: 16px 16px 0 0;
    }

    .main-image-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .image-gallery {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        padding: 1rem;
        background: #f9fafb;
    }

    .thumbnail {
        height: 80px;
        cursor: pointer;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .thumbnail:hover,
    .thumbnail.active {
        border-color: #FF6B35;
        transform: translateY(-1px);
    }

    .thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Property Info */
    .property-info-section {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
    }

    .property-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #f3f4f6;
    }

    .property-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
        line-height: 1.3;
        margin-bottom: 0.25rem;
    }

    .property-location {
        display: flex;
        align-items: center;
        color: #6b7280;
        font-size: 0.875rem;
    }

    .property-location i {
        margin-right: 0.5rem;
        color: #FF6B35;
    }

    .property-actions {
        display: flex;
        gap: 0.5rem;
    }

    .action-btn {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid #e5e7eb;
        background: white;
        font-size: 0.875rem;
    }

    .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .action-btn.share:hover {
        border-color: #3b82f6;
        color: #3b82f6;
    }

    .action-btn.print:hover {
        border-color: #10b981;
        color: #10b981;
    }

    .heart-btn {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 10px;
        background: white;
        border: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

    .heart-btn:hover {
        transform: translateY(-1px);
        border-color: #ef4444;
    }

    .heart-btn.active {
        background: #fef2f2;
        border-color: #ef4444;
        color: #ef4444;
    }

    /* Price Section */
    .price-section {
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    .price-display {
        font-size: 2rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.25rem;
    }

    .price-unit {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.75rem;
    }

    .price-details {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
    }

    .price-item {
        text-align: center;
        padding: 0.75rem;
        background: white;
        border-radius: 10px;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.05);
    }

    .price-label {
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }

    .price-value {
        font-size: 1rem;
        font-weight: 700;
        color: #111827;
    }

    /* Features Grid */
    .features-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .feature-card {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
        border: 1px solid #f3f4f6;
        transition: all 0.3s ease;
    }

    .feature-card:hover {
        border-color: #FF6B35;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 107, 53, 0.1);
    }

    .feature-icon {
        width: 2.5rem;
        height: 2.5rem;
        background: linear-gradient(135deg, #FF6B35, #FF8B5A);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.75rem;
        color: white;
        font-size: 1rem;
    }

    .feature-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.125rem;
    }

    .feature-label {
        font-size: 0.75rem;
        color: #6b7280;
    }

    /* Description */
    .description-section {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #f3f4f6;
    }

    .description-content {
        line-height: 1.6;
        color: #4b5563;
        font-size: 0.875rem;
    }

    .description-content p {
        margin-bottom: 0.75rem;
    }

    /* Amenities */
    .amenities-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
    }

    .amenity-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        background: #f9fafb;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-size: 0.75rem;
    }

    .amenity-item:hover {
        background: #f3f4f6;
        transform: translateY(-1px);
    }

    .amenity-item i {
        width: 1.5rem;
        height: 1.5rem;
        background: #e5e7eb;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.5rem;
        color: #4b5563;
        font-size: 0.75rem;
        flex-shrink: 0;
    }

    .amenity-item.active i {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    /* Seller Info */
    .seller-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        text-align: center;
        border: 1px solid transparent;
        transition: all 0.3s ease;
    }

    .seller-card:hover {
        border-color: #FF6B35;
        transform: translateY(-2px);
    }

    .seller-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        margin: 0 auto 0.75rem;
        border: 3px solid #f3f4f6;
    }

    .seller-name {
        font-size: 1.125rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.25rem;
    }

    .seller-type {
        display: inline-block;
        padding: 0.125rem 0.75rem;
        background: #f3f4f6;
        color: #6b7280;
        border-radius: 16px;
        font-size: 0.75rem;
        margin-bottom: 1rem;
    }

    .seller-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 1rem;
        font-weight: 700;
        color: #111827;
        display: block;
    }

    .stat-label {
        font-size: 0.625rem;
        color: #6b7280;
        display: block;
    }

    /* Inquiry Form */
    .inquiry-form {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.25rem;
    }

    .form-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.75rem;
        transition: all 0.3s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: #FF6B35;
        box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
    }

    .form-textarea {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.75rem;
        transition: all 0.3s ease;
        min-height: 80px;
        resize: vertical;
    }

    .form-textarea:focus {
        outline: none;
        border-color: #FF6B35;
        box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
    }

    /* Map Section */
    .map-section {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
    }

    .map-container {
        height: 300px;
        border-radius: 12px;
        overflow: hidden;
        margin-top: 0.75rem;
        border: 1px solid #f3f4f6;
    }

    /* Similar Properties */
    .similar-properties {
        margin-top: 2rem;
    }

    .properties-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .property-card {
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
        transition: all 0.3s ease;
        height: 100%;
    }

    .property-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px -5px rgba(255, 107, 53, 0.1);
        border-color: rgba(255, 107, 53, 0.2);
    }

    .property-image-container {
        position: relative;
        height: 180px;
        overflow: hidden;
    }

    .property-image-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .property-card:hover .property-image-container img {
        transform: scale(1.05);
    }

    /* Badges */
    .badges-container {
        display: flex;
        gap: 0.375rem;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
    }

    .badge {
        font-size: 0.625rem;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.125rem;
    }

    .badge-featured {
        background: linear-gradient(135deg, #FF6B35, #FF8B5A);
        color: white;
    }

    .badge-urgent {
        background: linear-gradient(135deg, #ef4444, #f87171);
        color: white;
    }

    .badge-verified {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .badge-new {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
    }

    /* Layout */
    .two-column-layout {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
    }

    /* Buttons */
    .btn-primary {
        padding: 0.5rem;
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        border-radius: 8px;
        font-weight: 600;
        text-align: center;
        text-decoration: none;
        transition: all 0.3s ease;
        font-size: 0.75rem;
        flex: 1;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
        padding: 0.5rem;
        background: #f3f4f6;
        color: #374151;
        border-radius: 8px;
        font-weight: 600;
        text-align: center;
        text-decoration: none;
        transition: all 0.3s ease;
        font-size: 0.75rem;
        flex: 1;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
        transform: translateY(-1px);
    }

    .btn-gradient {
        background: linear-gradient(135deg, #FF6B35, #FF8B5A);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.75rem;
    }

    .btn-gradient:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
    }

    .btn-gradient:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Property Features Grid */
    .property-features {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.375rem;
        margin-bottom: 1rem;
    }

    .feature-item {
        text-align: center;
    }

    .feature-value {
        font-size: 0.875rem;
        font-weight: 700;
        color: #111827;
        display: block;
    }

    .feature-label {
        font-size: 0.625rem;
        color: #6b7280;
        display: block;
    }

    /* Property Content */
    .property-content {
        padding: 1rem;
    }

    .property-price {
        font-size: 1.25rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.125rem;
    }

    .price-unit {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .property-actions-small {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .two-column-layout {
            grid-template-columns: 1fr;
        }

        .main-image-container {
            height: 250px;
        }

        .image-gallery {
            grid-template-columns: repeat(2, 1fr);
        }

        .features-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .price-details {
            grid-template-columns: 1fr;
        }

        .amenities-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .seller-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .properties-grid {
            grid-template-columns: 1fr;
        }

        .property-header {
            flex-direction: column;
            gap: 0.75rem;
        }

        .property-actions {
            align-self: flex-start;
        }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
        .two-column-layout {
            grid-template-columns: 3fr 2fr;
        }

        .features-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        .amenities-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* Toast Container */
    .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-width: 300px;
    }

    .toast {
        background: linear-gradient(135deg, #111827, #1f2937);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        animation: slideInRight 0.3s ease;
        font-size: 0.75rem;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-spinner {
        width: 3rem;
        height: 3rem;
        border: 3px solid #f3f4f6;
        border-top: 3px solid #FF6B35;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block header_title %}
<h1 class="text-xl font-bold text-gray-900">
    <span class="gradient-text">Property Details</span>
</h1>
<p class="text-xs text-gray-600 mt-1">
    <i class="fas fa-info-circle text-blue-500 mr-1"></i>
    Complete information about the property
</p>
{% endblock %}

{% block header_buttons %}
<div class="flex flex-wrap gap-2">
    <button onclick="window.history.back()" 
            class="px-3 py-1.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all duration-300 flex items-center gap-1 text-xs font-medium">
        <i class="fas fa-arrow-left text-xs"></i>
        <span class="hidden sm:inline">Back</span>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="content-spacing property-detail-container">
    <!-- Image Gallery -->
    <div class="property-gallery">
        <div class="main-image-container" id="mainImage">
            {% if property.primary_image %}
            <img src="{{ property.primary_image.url }}" 
                 alt="{{ property.title }}" 
                 id="currentImage">
            {% else %}
            <div class="w-full h-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center">
                <i class="fas fa-home text-4xl text-gray-400"></i>
            </div>
            {% endif %}
        </div>
        
        <div class="image-gallery">
            {% for image in images %}
            <div class="thumbnail {% if forloop.first %}active{% endif %}" 
                 onclick="changeImage('{{ image.image.url }}', this)">
                <img src="{{ image.image.url }}" alt="{{ image.caption|default:property.title }}">
            </div>
            {% endfor %}
            
            {% if not images %}
            {% for i in "1234" %}
            <div class="thumbnail">
                <div class="w-full h-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center">
                    <i class="fas fa-home text-sm text-gray-400"></i>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>

    <!-- Main Content -->
    <div class="two-column-layout">
        <!-- Left Column -->
        <div class="left-column">
            <!-- Property Info -->
            <div class="property-info-section">
                <div class="property-header">
                    <div class="flex-1">
                        <div class="badges-container">
                            {% if property.is_featured %}
                            <span class="badge badge-featured">
                                <i class="fas fa-star"></i> Featured
                            </span>
                            {% endif %}
                            
                            {% if property.is_urgent %}
                            <span class="badge badge-urgent">
                                <i class="fas fa-bolt"></i> Urgent
                            </span>
                            {% endif %}
                            
                            {% if property.is_verified %}
                            <span class="badge badge-verified">
                                <i class="fas fa-check"></i> Verified
                            </span>
                            {% endif %}
                            
                            <span class="badge badge-new">
                                <i class="fas fa-clock"></i> {{ property.created_at|timesince }} ago
                            </span>
                        </div>
                        
                        <h1 class="property-title">{{ property.title }}</h1>
                        
                        <div class="property-location">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>{{ property.address }}, {{ property.city }}, {{ property.state }} - {{ property.pincode }}</span>
                        </div>
                    </div>
                    
                    <div class="property-actions">
                        <button class="heart-btn {% if is_favorited %}active{% endif %}" 
                                onclick="toggleFavorite('{{ property.id }}', this)">
                            <i class="fas fa-heart"></i>
                        </button>
                        
                        <button class="action-btn share" onclick="shareProperty()">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        
                        <button class="action-btn print" onclick="window.print()">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                </div>

                <!-- Price Section -->
                <div class="price-section">
                    <div class="price-display">₹{{ property.price|intcomma }}</div>
                    <div class="price-unit">
                        {% if property.property_for in 'rent,pg' %}
                        Per Month • 
                        {% endif %}
                        Price {% if property.price_negotiable %}(Negotiable){% else %}(Fixed){% endif %}
                    </div>
                    
                    <div class="price-details">
                        <div class="price-item">
                            <div class="price-label">Price per sq.ft.</div>
                            <div class="price-value">₹{{ property.price_per_sqft|default:0|floatformat:2|intcomma }}</div>
                        </div>
                        
                        <div class="price-item">
                            <div class="price-label">Maintenance</div>
                            <div class="price-value">
                                {% if property.maintenance_charges %}
                                ₹{{ property.maintenance_charges|intcomma }}/month
                                {% else %}
                                N/A
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="price-item">
                            <div class="price-label">Deposit</div>
                            <div class="price-value">
                                {% if property.booking_amount %}
                                ₹{{ property.booking_amount|intcomma }}
                                {% else %}
                                N/A
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Features Grid -->
                <div class="features-grid">
                    {% if property.bedrooms %}
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-bed"></i>
                        </div>
                        <div class="feature-value">{{ property.bedrooms }}</div>
                        <div class="feature-label">Bedrooms</div>
                    </div>
                    {% endif %}
                    
                    {% if property.bathrooms %}
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-bath"></i>
                        </div>
                        <div class="feature-value">{{ property.bathrooms }}</div>
                        <div class="feature-label">Bathrooms</div>
                    </div>
                    {% endif %}
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-ruler-combined"></i>
                        </div>
                        <div class="feature-value">{{ property.carpet_area|intcomma }}</div>
                        <div class="feature-label">Sq.ft Area</div>
                    </div>
                    
                    {% if property.balconies %}
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-archway"></i>
                        </div>
                        <div class="feature-value">{{ property.balconies }}</div>
                        <div class="feature-label">Balconies</div>
                    </div>
                    {% endif %}
                    
                    {% if property.floor_number %}
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="feature-value">{{ property.floor_number }}</div>
                        <div class="feature-label">Floor</div>
                    </div>
                    {% endif %}
                    
                    {% if property.age_of_property %}
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="feature-value">{{ property.age_of_property }}</div>
                        <div class="feature-label">Property Age</div>
                    </div>
                    {% endif %}
                    
                    {% if property.furnishing %}
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-couch"></i>
                        </div>
                        <div class="feature-value">{{ property.get_furnishing_display }}</div>
                        <div class="feature-label">Furnishing</div>
                    </div>
                    {% endif %}
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="feature-value">{{ property.view_count|intcomma }}</div>
                        <div class="feature-label">Views</div>
                    </div>
                </div>
            </div>

            <!-- Description -->
            <div class="description-section">
                <h2 class="section-title">Description</h2>
                <div class="description-content">
                    {{ property.description|linebreaks }}
                </div>
            </div>

            <!-- Amenities -->
            {% if property.amenities %}
            <div class="description-section">
                <h2 class="section-title">Amenities & Features</h2>
                <div class="amenities-grid">
                    {% for amenity_key, amenity_value in property.amenities.items %}
                    {% if amenity_value %}
                    <div class="amenity-item active">
                        <i class="fas fa-check"></i>
                        <span>{{ amenity_key|title }}</span>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Map Section -->
            {% if property.latitude and property.longitude %}
            <div class="map-section">
                <h2 class="section-title">Location</h2>
                <div class="property-location mb-3">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>{{ property.address }}, {{ property.city }}, {{ property.state }}</span>
                </div>
                <div class="map-container" id="propertyMap">
                    <div class="w-full h-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-map-marked-alt text-2xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600 text-xs">Map View</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column -->
        <div class="right-column">
            <!-- Seller Info -->
            <div class="seller-card">
                {% if seller.profile.avatar %}
                <img src="{{ seller.profile.avatar.url }}" 
                     alt="{{ seller.get_full_name }}" 
                     class="seller-avatar">
                {% else %}
                <div class="seller-avatar bg-gradient-to-br from-orange-200 to-orange-300 flex items-center justify-center">
                    <i class="fas fa-user text-xl text-orange-500"></i>
                </div>
                {% endif %}
                
                <h3 class="seller-name">{{ seller.get_full_name|default:seller.email }}</h3>
                
                <div class="seller-type">
                    {{ seller.get_user_type_display }}
                    {% if seller.seller_type %}
                    • {{ seller.get_seller_type_display }}
                    {% endif %}
                </div>
                
                <div class="seller-stats">
                    <div class="stat-item">
                        <span class="stat-value">{{ seller_listings_count }}</span>
                        <span class="stat-label">Listings</span>
                    </div>
                    
                    <div class="stat-item">
                        <span class="stat-value">{{ seller_avg_views|floatformat:"0" }}</span>
                        <span class="stat-label">Avg Views</span>
                    </div>
                    
                    <div class="stat-item">
                        <span class="stat-value">
                            {% if seller.profile and seller.profile.experience_years %}
                            {{ seller.profile.experience_years }}+ yrs
                            {% else %}
                            N/A
                            {% endif %}
                        </span>
                        <span class="stat-label">Experience</span>
                    </div>
                </div>
                
                <div class="flex flex-col gap-2">
                    {% if property.show_contact and property.contact_phone %}
                    <a href="tel:{{ property.contact_phone }}" 
                       class="w-full py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-semibold flex items-center justify-center gap-1 hover:shadow-md transition-all duration-300 text-xs">
                        <i class="fas fa-phone"></i>
                        Call {{ property.contact_person|slice:":10" }}
                    </a>
                    {% endif %}
                    
                    {% if property.contact_phone %}
                    <a href="https://wa.me/{{ property.contact_phone|cut:'+' }}?text=Hi, I'm interested in your property: {{ property.title }}"
                       target="_blank"
                       class="w-full py-2 bg-gradient-to-r from-[#25D366] to-[#128C7E] text-white rounded-lg font-semibold flex items-center justify-center gap-1 hover:shadow-md transition-all duration-300 text-xs">
                        <i class="fab fa-whatsapp"></i>
                        WhatsApp
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Inquiry Form -->
            <div class="inquiry-form">
                <h2 class="section-title mb-4">Make an Inquiry</h2>
                
                {% if has_inquired %}
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <div class="flex items-start gap-2">
                        <i class="fas fa-check-circle text-blue-500 text-base mt-0.5"></i>
                        <div>
                            <h4 class="font-semibold text-blue-800 mb-1 text-xs">Inquiry Sent!</h4>
                            <p class="text-blue-600 text-xs">You've already inquired about this property. The seller will contact you soon.</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <form id="inquiryForm" class="space-y-3">
                    <div class="form-group">
                        <label class="form-label">Your Name</label>
                        <input type="text" 
                               name="name" 
                               value="{{ user.get_full_name|default:'' }}"
                               class="form-input"
                               required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Your Email</label>
                        <input type="email" 
                               name="email" 
                               value="{{ user.email|default:'' }}"
                               class="form-input"
                               required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Your Phone</label>
                        <input type="tel" 
                               name="phone" 
                               value="{{ user.phone|default:'' }}"
                               class="form-input"
                               required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <textarea name="message" 
                                  class="form-textarea"
                                  placeholder="I'm interested in this property. Please provide more details..."
                                  required></textarea>
                    </div>
                    
                    <button type="submit" 
                            class="w-full btn-gradient py-2 font-semibold flex items-center justify-center gap-1"
                            {% if has_inquired %}disabled{% endif %}>
                        <i class="fas fa-paper-plane"></i>
                        {% if has_inquired %}Inquiry Sent{% else %}Send Inquiry{% endif %}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Similar Properties -->
    {% if similar_properties %}
    <div class="similar-properties">
        <h2 class="section-title mb-2">Similar Properties</h2>
        <p class="text-gray-600 mb-3 text-xs">You might also be interested in these properties in the same area</p>
        
        <div class="properties-grid">
            {% for similar in similar_properties %}
            <div class="property-card">
                <div class="property-image-container">
                    {% if similar.primary_image %}
                    <img src="{{ similar.primary_image.url }}" alt="{{ similar.title }}">
                    {% else %}
                    <div class="w-full h-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center">
                        <i class="fas fa-home text-3xl text-gray-400"></i>
                    </div>
                    {% endif %}
                    
                    <button class="heart-btn" onclick="toggleFavorite('{{ similar.id }}', this)">
                        <i class="fas fa-heart"></i>
                    </button>
                    
                    <div class="property-badges">
                        {% if similar.is_featured %}
                        <span class="badge badge-featured">
                            <i class="fas fa-star mr-1"></i> Featured
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="property-content">
                    <h3 class="property-title line-clamp-2 text-sm">{{ similar.title }}</h3>
                    
                    <div class="property-location text-xs">
                        <i class="fas fa-map-marker-alt"></i>
                        <span class="line-clamp-1">{{ similar.city }}, {{ similar.state }}</span>
                    </div>
                    
                    <div class="property-features">
                        {% if similar.bedrooms %}
                        <div class="feature-item">
                            <span class="feature-value">{{ similar.bedrooms }}</span>
                            <span class="feature-label">Beds</span>
                        </div>
                        {% endif %}
                        
                        {% if similar.bathrooms %}
                        <div class="feature-item">
                            <span class="feature-value">{{ similar.bathrooms }}</span>
                            <span class="feature-label">Baths</span>
                        </div>
                        {% endif %}
                        
                        <div class="feature-item">
                            <span class="feature-value">{{ similar.carpet_area|intcomma }}</span>
                            <span class="feature-label">Sq.ft</span>
                        </div>
                        
                        <div class="feature-item">
                            <span class="feature-value">
                                {% if similar.property_for in 'rent,pg' %}
                                Rent
                                {% else %}
                                Sale
                                {% endif %}
                            </span>
                            <span class="feature-label">Type</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="property-price">₹{{ similar.price|intcomma }}</div>
                            {% if similar.property_for in 'rent,pg' %}
                            <div class="price-unit text-xs">/month</div>
                            {% endif %}
                        </div>
                        
                        <div class="text-xs text-gray-600">
                            <i class="fas fa-eye mr-1"></i>{{ similar.view_count }}
                        </div>
                    </div>
                    
                    <div class="property-actions-small">
                        <a href="{% url 'buyer_property_detail' similar.slug %}" 
                           class="btn-primary">
                            View Details
                        </a>
                        
                        <button onclick="quickInquiry('{{ similar.id }}')" 
                                class="btn-secondary">
                            <i class="fas fa-envelope mr-1"></i>Inquire
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Hide loading overlay if it's shown
        hideLoading();

        // Initialize image gallery
        try {
            initializeGallery();
        } catch (e) {
            console.error('Error initializing gallery:', e);
        }

        // Initialize maps if available
        if (document.getElementById('propertyMap')) {
            try {
                loadMap();
            } catch (e) {
                console.error('Error loading map:', e);
            }
        }

        // Initialize forms
        try {
            initializeForms();
        } catch (e) {
            console.error('Error initializing forms:', e);
        }
    });

    function initializeGallery() {
        const thumbnails = document.querySelectorAll('.thumbnail');
        const mainImage = document.getElementById('currentImage');
        
        thumbnails.forEach(thumbnail => {
            thumbnail.addEventListener('click', function() {
                // Remove active class from all thumbnails
                thumbnails.forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked thumbnail
                this.classList.add('active');
                
                // Change main image
                if (mainImage) {
                    const img = this.querySelector('img');
                    if (img) {
                        mainImage.src = img.src;
                        mainImage.alt = img.alt;
                        
                        // Add fade effect
                        mainImage.style.opacity = '0';
                        setTimeout(() => {
                            mainImage.style.opacity = '1';
                        }, 200);
                    }
                }
            });
        });
    }

    function changeImage(imageUrl, element) {
        const mainImage = document.getElementById('currentImage');
        if (mainImage) {
            mainImage.src = imageUrl;
            
            // Update active thumbnail
            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
        }
    }

    function loadMap() {
        const lat = parseFloat('{{ property.latitude|default:"12.9716" }}');
        const lng = parseFloat('{{ property.longitude|default:"77.5946" }}');
        const address = '{{ property.address }}, {{ property.city }}, {{ property.state }}';
        
        const mapContainer = document.getElementById('propertyMap');
        if (lat && lng) {
            // Using OpenStreetMap as it doesn't require API key
            mapContainer.innerHTML = `
                <iframe 
                    src="https://www.openstreetmap.org/export/embed.html?bbox=${lng-0.01},${lat-0.01},${lng+0.01},${lat+0.01}&layer=mapnik&marker=${lat},${lng}"
                    width="100%"
                    height="100%"
                    style="border: none;"
                    allowfullscreen=""
                    loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade">
                </iframe>
            `;
        }
    }

    function toggleFavorite(propertyId, button) {
        const isFavorited = button.classList.contains('active');
        
        // Update UI immediately
        if (isFavorited) {
            button.classList.remove('active');
            showToast('Removed from favorites', 'info');
        } else {
            button.classList.add('active');
            showToast('Added to favorites!', 'success');
            
            // Animation
            button.style.transform = 'scale(1.1)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
            }, 300);
        }
        
        // Send AJAX request
        fetch('{% url "ajax_toggle_favorite" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                property_id: propertyId,
                action: isFavorited ? 'remove' : 'add'
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                // Revert UI on error
                if (isFavorited) {
                    button.classList.add('active');
                    showToast('Failed to remove from favorites', 'error');
                } else {
                    button.classList.remove('active');
                    showToast('Failed to add to favorites', 'error');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Network error. Please try again.', 'error');
        });
    }

    function initializeForms() {
        // Inquiry form
        const inquiryForm = document.getElementById('inquiryForm');
        if (inquiryForm) {
            inquiryForm.addEventListener('submit', function(e) {
                e.preventDefault();
                sendInquiry();
            });
        }
    }

    function sendInquiry() {
        const form = document.getElementById('inquiryForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.property_id = '{{ property.id }}';
        
        // Show loading
        showLoading('Sending inquiry...');
        
        fetch('{% url "ajax_send_inquiry" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                showToast('Inquiry sent successfully!', 'success');
                // Disable form and show success message
                form.querySelectorAll('input, textarea, button').forEach(el => {
                    el.disabled = true;
                });
                
                // Update button text
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> Inquiry Sent';
                    submitBtn.classList.remove('btn-gradient');
                    submitBtn.classList.add('bg-gray-300', 'text-gray-600');
                }
            } else {
                showToast(data.error || 'Failed to send inquiry', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('Network error. Please try again.', 'error');
        });
    }

    function quickInquiry(propertyId) {
        const message = prompt('Enter your inquiry message for this property:');
        if (message && message.trim()) {
            showLoading('Sending inquiry...');
            
            fetch('{% url "ajax_send_inquiry" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    property_id: propertyId,
                    name: '{{ user.get_full_name|default:"" }}',
                    email: '{{ user.email }}',
                    phone: '{{ user.phone|default:"" }}',
                    message: message.trim()
                }),
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    showToast('Inquiry sent successfully!', 'success');
                } else {
                    showToast(data.error || 'Failed to send inquiry', 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showToast('Network error. Please try again.', 'error');
            });
        }
    }

    function shareProperty() {
        const shareData = {
            title: '{{ property.title }}',
            text: 'Check out this property on BHOOSPARSH: {{ property.title }} in {{ property.city }}',
            url: window.location.href,
        };
        
        if (navigator.share) {
            navigator.share(shareData)
                .then(() => showToast('Shared successfully!', 'success'))
                .catch(err => {
                    if (err.name !== 'AbortError') {
                        // Fallback to clipboard
                        copyToClipboard();
                    }
                });
        } else {
            // Fallback: copy to clipboard
            copyToClipboard();
        }
    }

    function copyToClipboard() {
        navigator.clipboard.writeText(window.location.href)
            .then(() => showToast('Link copied to clipboard!', 'success'))
            .catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy link', 'error');
            });
    }

    function showLoading(message = 'Loading...') {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'loading-overlay';
        loadingOverlay.innerHTML = `
            <div class="bg-white rounded-lg p-6 shadow-xl">
                <div class="flex flex-col items-center gap-3">
                    <div class="loading-spinner"></div>
                    <p class="text-gray-700 font-medium text-sm">${message}</p>
                </div>
            </div>
        `;
        document.body.appendChild(loadingOverlay);
    }

    function hideLoading() {
        const loadingOverlay = document.querySelector('.loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.remove();
        }
    }

    function showToast(message, type = 'info') {
        // Create container if it doesn't exist
        let container = document.getElementById('toastContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container';
            document.body.appendChild(container);
        }
        
        const toast = document.createElement('div');
        toast.className = 'toast';
        
        const icons = {
            info: 'fa-info-circle',
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle'
        };
        
        const colors = {
            info: '#3b82f6',
            success: '#10b981',
            error: '#ef4444',
            warning: '#f59e0b'
        };
        
        toast.innerHTML = `
            <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0" 
                 style="background: ${colors[type]}">
                <i class="fas ${icons[type]} text-white text-xs"></i>
            </div>
            <div class="flex-1">
                <span class="font-medium">${message}</span>
            </div>
            <button onclick="this.parentElement.remove()" class="text-white/80 hover:text-white transition-colors flex-shrink-0">
                <i class="fas fa-times text-xs"></i>
            </button>
        `;
        
        container.appendChild(toast);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 4000);
    }

    // Utility function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}