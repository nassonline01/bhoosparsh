{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}Select Plan - RealEstatePro{% endblock %}

{% block extra_css %}
<style>
    .selected-plan {
        border: 3px solid #8b5cf6;
        background: linear-gradient(135deg, #f3f4f6 0%, #ffffff 100%);
    }
    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    .step-active {
        background: #8b5cf6;
        color: white;
    }
    .step-inactive {
        background: #e5e7eb;
        color: #6b7280;
    }
    .plan-option {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .plan-option:hover {
        border-color: #8b5cf6;
        transform: translateY(-2px);
    }
    .plan-option.selected {
        border-color: #8b5cf6;
        background-color: #f5f3ff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Progress Steps -->
    <div class="max-w-3xl mx-auto mb-12">
        <div class="flex justify-between items-center relative">
            <!-- Line -->
            <div class="absolute top-1/2 left-0 right-0 h-1 bg-gray-200 -z-10"></div>
            
            <!-- Step 1 -->
            <div class="flex flex-col items-center">
                <div class="step-circle step-active mb-2">
                    <i class="fas fa-check"></i>
                </div>
                <span class="text-sm font-semibold text-purple-600">Select Plan</span>
            </div>

            <!-- Step 2 -->
            <div class="flex flex-col items-center">
                <div class="step-circle step-inactive mb-2">2</div>
                <span class="text-sm text-gray-500">Checkout</span>
            </div>

            <!-- Step 3 -->
            <div class="flex flex-col items-center">
                <div class="step-circle step-inactive mb-2">3</div>
                <span class="text-sm text-gray-500">Complete</span>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Plan Selection -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-2">Choose Your Plan</h2>
                    <p class="text-gray-600 mb-6">Select the perfect plan for your real estate business</p>

                    <form method="post" id="planForm">
                        {% csrf_token %}
                        
                        <!-- Plan Options -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                            {% for plan in plans %}
                            <div class="plan-option p-4 {% if selected_plan.id == plan.id or forloop.first %}selected{% endif %}" 
                                 onclick="selectPlan({{ plan.id }})">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h4 class="font-bold text-lg">{{ plan.name }}</h4>
                                        <div class="flex items-center mt-1">
                                            <span class="text-2xl font-bold">₹{{ plan.monthly_price|floatformat:0 }}</span>
                                            <span class="text-gray-600 ml-2">/month</span>
                                        </div>
                                    </div>
                                    <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                        <div class="w-3 h-3 rounded-full bg-purple-600 hidden"></div>
                                    </div>
                                </div>
                                
                                <ul class="text-sm text-gray-600 space-y-1 mb-3">
                                    {% for feature in plan.popular_features|slice:":3" %}
                                    <li><i class="fas fa-check text-green-500 mr-2"></i>{{ feature }}</li>
                                    {% endfor %}
                                </ul>
                                
                                <div class="text-xs text-gray-500">
                                    {% if plan.has_trial %}
                                    <i class="fas fa-gift text-purple-500 mr-1"></i> {{ plan.trial_days }}-day free trial
                                    {% endif %}
                                </div>
                                
                                <input type="radio" name="plan" value="{{ plan.id }}" 
                                       class="hidden" 
                                       {% if selected_plan.id == plan.id or forloop.first %}checked{% endif %}>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Billing Duration -->
                        <div class="mb-8">
                            <h3 class="font-bold text-lg mb-4">Billing Duration</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <label class="plan-option p-4 text-center cursor-pointer" onclick="selectDuration('monthly')">
                                    <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center mx-auto mb-2">
                                        <div class="w-3 h-3 rounded-full bg-purple-600"></div>
                                    </div>
                                    <div class="font-semibold">Monthly</div>
                                    <div class="text-sm text-gray-600">Flexible, cancel anytime</div>
                                    <input type="radio" name="duration" value="monthly" class="hidden" checked>
                                </label>

                                <label class="plan-option p-4 text-center cursor-pointer" onclick="selectDuration('annual')">
                                    <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center mx-auto mb-2">
                                        <div class="w-3 h-3 rounded-full bg-purple-600 hidden"></div>
                                    </div>
                                    <div class="font-semibold">Annual</div>
                                    <div class="text-sm text-gray-600">
                                        Save {{ selected_plan.yearly_savings|default:0 }}%
                                        <span class="block text-green-600 font-bold">Best Value</span>
                                    </div>
                                    <input type="radio" name="duration" value="annual" class="hidden">
                                </label>
                            </div>
                        </div>

                        <!-- Terms Agreement -->
                        <div class="mb-8">
                            <label class="flex items-start">
                                <input type="checkbox" name="accept_terms" required 
                                       class="mt-1 mr-3 w-5 h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                <span class="text-gray-700">
                                    I agree to the 
                                    <a href="{% url 'terms' %}" class="text-purple-600 hover:underline">Terms of Service</a>
                                    and 
                                    <a href="#" class="text-purple-600 hover:underline">Privacy Policy</a>. 
                                    I understand that my subscription will automatically renew unless I cancel.
                                </span>
                            </label>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-between items-center">
                            <a href="{% url 'pricing' %}" class="text-gray-600 hover:text-gray-800">
                                <i class="fas fa-arrow-left mr-2"></i> Back to Pricing
                            </a>
                            <button type="submit" class="bg-purple-600 text-white px-8 py-3 rounded-lg hover:bg-purple-700 transition font-semibold">
                                Continue to Checkout
                                <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Features Comparison -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="font-bold text-xl mb-4">Plan Features Comparison</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <tbody>
                                <tr class="border-b">
                                    <td class="py-3 font-medium">Active Listings</td>
                                    <td class="py-3 text-center">
                                        <span id="feature-listings">-</span>
                                    </td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-3 font-medium">Featured Listings/Month</td>
                                    <td class="py-3 text-center">
                                        <span id="feature-featured">-</span>
                                    </td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-3 font-medium">Priority Ranking</td>
                                    <td class="py-3 text-center">
                                        <span id="feature-priority">-</span>
                                    </td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-3 font-medium">Advanced Analytics</td>
                                    <td class="py-3 text-center">
                                        <span id="feature-analytics">-</span>
                                    </td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-3 font-medium">Free Trial</td>
                                    <td class="py-3 text-center">
                                        <span id="feature-trial">-</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column: Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-6 sticky top-6">
                    <h3 class="font-bold text-xl mb-6">Order Summary</h3>
                    
                    <!-- Selected Plan -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold" id="summary-plan">Basic Plan</span>
                            <span class="font-bold" id="summary-price">₹0</span>
                        </div>
                        <div class="text-sm text-gray-600" id="summary-duration">Monthly billing</div>
                    </div>

                    <!-- Features -->
                    <div class="space-y-3 mb-6">
                        <div class="flex items-center text-sm">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span id="summary-listings">1 Active Listing</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span id="summary-featured">Standard Visibility</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <i class="fas fa-check text-green-500 mr-2"></i>
                            <span id="summary-badge">Basic Profile</span>
                        </div>
                    </div>

                    <!-- Total -->
                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold">Subtotal</span>
                            <span class="font-bold" id="summary-subtotal">₹0</span>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-600 mb-4">
                            <span>Tax (18% GST)</span>
                            <span id="summary-tax">₹0</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-bold border-t pt-4">
                            <span>Total</span>
                            <span id="summary-total">₹0</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-2" id="summary-savings"></div>
                    </div>

                    <!-- Help -->
                    <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                            <div class="text-sm">
                                <div class="font-semibold mb-1">Need Help?</div>
                                <div class="text-gray-600">
                                    Contact our support team for assistance with plan selection.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Plan data from template context
    const plans = {
        {% for plan in plans %}
        {{ plan.id }}: {
            name: "{{ plan.name }}",
            monthlyPrice: {{ plan.monthly_price }},
            annualPrice: {{ plan.annual_price|default:plan.monthly_price|mul:12 }},
            yearlySavings: {{ plan.yearly_savings|default:0 }},
            maxListings: {{ plan.max_active_listings }},
            maxFeatured: {{ plan.max_featured_listings }},
            hasPriority: {{ plan.has_priority_ranking|yesno:"true,false" }},
            hasAnalytics: {{ plan.has_advanced_analytics|yesno:"true,false" }},
            trialDays: {{ plan.trial_days|default:0 }},
            badge: "{{ plan.badge_text|default:'' }}",
            isUnlimited: {{ plan.is_unlimited|yesno:"true,false" }}
        },
        {% endfor %}
    };

    let selectedPlanId = {% if selected_plan %}{{ selected_plan.id }}{% else %}{{ plans.0.id }}{% endif %};
    let selectedDuration = 'monthly';

    function selectPlan(planId) {
        selectedPlanId = planId;
        
        // Update UI
        document.querySelectorAll('.plan-option').forEach(option => {
            option.classList.remove('selected');
            const radio = option.querySelector('input[type="radio"]');
            if (radio && parseInt(radio.value) === planId) {
                option.classList.add('selected');
                radio.checked = true;
            }
        });
        
        // Update features display
        updateFeatures();
        updateOrderSummary();
    }

    function selectDuration(duration) {
        selectedDuration = duration;
        
        // Update UI
        document.querySelectorAll('[name="duration"]').forEach(radio => {
            const parent = radio.closest('.plan-option');
            if (radio.value === duration) {
                radio.checked = true;
                parent.classList.add('selected');
                parent.querySelector('.bg-purple-600').classList.remove('hidden');
            } else {
                parent.classList.remove('selected');
                parent.querySelector('.bg-purple-600').classList.add('hidden');
            }
        });
        
        updateOrderSummary();
    }

    function updateFeatures() {
        const plan = plans[selectedPlanId];
        if (!plan) return;
        
        // Update features table
        document.getElementById('feature-listings').textContent = 
            plan.isUnlimited ? 'Unlimited' : plan.maxListings;
        
        document.getElementById('feature-featured').textContent = 
            plan.maxFeatured > 0 ? plan.maxFeatured : 'None';
        
        document.getElementById('feature-priority').innerHTML = 
            plan.hasPriority ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-times text-red-400"></i>';
        
        document.getElementById('feature-analytics').innerHTML = 
            plan.hasAnalytics ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-times text-red-400"></i>';
        
        document.getElementById('feature-trial').textContent = 
            plan.trialDays > 0 ? `${plan.trialDays} days` : 'None';
    }

    function updateOrderSummary() {
        const plan = plans[selectedPlanId];
        if (!plan) return;
        
        const price = selectedDuration === 'annual' ? plan.annualPrice : plan.monthlyPrice;
        const tax = price * 0.18;
        const total = price + tax;
        
        // Update summary
        document.getElementById('summary-plan').textContent = plan.name;
        document.getElementById('summary-price').textContent = `₹${price.toFixed(0)}`;
        document.getElementById('summary-duration').textContent = 
            selectedDuration === 'annual' ? 'Annual billing (Save 20%)' : 'Monthly billing';
        
        document.getElementById('summary-listings').textContent = 
            plan.isUnlimited ? 'Unlimited Active Listings' : `${plan.maxListings} Active Listings`;
        
        document.getElementById('summary-featured').textContent = 
            plan.maxFeatured > 0 ? `${plan.maxFeatured} Featured Listings/Month` : 'Standard Visibility';
        
        document.getElementById('summary-badge').textContent = 
            plan.badge ? `${plan.badge} Badge` : 'Basic Profile';
        
        document.getElementById('summary-subtotal').textContent = `₹${price.toFixed(2)}`;
        document.getElementById('summary-tax').textContent = `₹${tax.toFixed(2)}`;
        document.getElementById('summary-total').textContent = `₹${total.toFixed(2)}`;
        
        if (selectedDuration === 'annual' && plan.yearlySavings > 0) {
            const monthlyTotal = plan.monthlyPrice * 12;
            const savings = monthlyTotal - plan.annualPrice;
            document.getElementById('summary-savings').textContent =
                `You save ₹${savings.toFixed(0)} per year!`;
        } else {
            document.getElementById('summary-savings').textContent = '';
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        selectPlan(selectedPlanId);
        selectDuration('monthly');
        
        // Form submission
        document.getElementById('planForm').addEventListener('submit', function(e) {
            // Validate terms
            if (!this.querySelector('[name="accept_terms"]').checked) {
                e.preventDefault();
                alert('Please accept the terms and conditions to continue.');
                return;
            }
        });
    });
</script>
{% endblock %}