{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}Buy Credits - RealEstatePro{% endblock %}

{% block extra_css %}
<style>
    .credit-package {
        border: 3px solid transparent;
        transition: all 0.3s ease;
    }
    .credit-package:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .credit-package.popular {
        border-color: #8b5cf6;
        position: relative;
        overflow: hidden;
    }
    .popular-tag {
        position: absolute;
        top: 15px;
        right: -35px;
        background: #8b5cf6;
        color: white;
        padding: 5px 40px;
        transform: rotate(45deg);
        font-size: 12px;
        font-weight: bold;
    }
    .credit-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    .discount-badge {
        position: absolute;
        top: 15px;
        left: 15px;
        background: #ef4444;
        color: white;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="text-center mb-12">
        <h1 class="text-3xl font-bold mb-4">Buy Credits</h1>
        <p class="text-gray-600 max-w-2xl mx-auto">
            Purchase credits to feature your properties, bump them up in search results, 
            and highlight them for maximum visibility.
        </p>
    </div>

    <!-- Current Balance -->
    {% if request.user.credits %}
    <div class="mb-8">
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-xl font-bold mb-2">Your Current Balance</h2>
                    <p class="text-purple-100">Use credits to boost your property visibility</p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold">
                        {{ request.user.credits.featured_listing_credits }}
                    </div>
                    <div class="text-purple-200">Featured Credits</div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-white bg-opacity-30 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-star"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-bold">{{ request.user.credits.featured_listing_credits }}</div>
                            <div class="text-sm text-purple-200">Featured Listings</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-white bg-opacity-30 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-bold">{{ request.user.credits.bump_up_credits }}</div>
                            <div class="text-sm text-purple-200">Bump Up Credits</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-white bg-opacity-30 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-highlighter"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-bold">{{ request.user.credits.highlight_credits }}</div>
                            <div class="text-sm text-purple-200">Highlight Credits</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Credit Packages -->
    <div class="mb-12">
        <h2 class="text-2xl font-bold mb-6 text-center">Choose a Credit Package</h2>
        
        <form method="post" id="creditForm">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto">
                {% for package in credit_packages %}
                <div class="credit-package bg-white rounded-xl p-6 shadow border {% if forloop.counter == 2 %}popular{% endif %}">
                    {% if forloop.counter == 2 %}
                    <div class="popular-tag">POPULAR</div>
                    {% endif %}
                    
                    {% if package.discount_percentage > 0 %}
                    <div class="discount-badge">Save {{ package.discount_percentage }}%</div>
                    {% endif %}
                    
                    <div class="text-center mb-6">
                        <div class="credit-icon {% if forloop.counter == 1 %}bg-blue-100 text-blue-600{% elif forloop.counter == 2 %}bg-purple-100 text-purple-600{% else %}bg-yellow-100 text-yellow-600{% endif %} mx-auto mb-4">
                            {% if forloop.counter == 1 %}
                            <i class="fas fa-gem"></i>
                            {% elif forloop.counter == 2 %}
                            <i class="fas fa-crown"></i>
                            {% else %}
                            <i class="fas fa-rocket"></i>
                            {% endif %}
                        </div>
                        
                        <h3 class="text-xl font-bold mb-2">{{ package.name }}</h3>
                        
                        <div class="mb-4">
                            <div class="text-4xl font-bold">₹{{ package.price|floatformat:0 }}</div>
                            {% if package.original_price %}
                            <div class="text-gray-500 line-through">₹{{ package.original_price|floatformat:0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="text-sm text-gray-600 mb-2">Valid for {{ package.validity_days }} days</div>
                    </div>
                    
                    <!-- Credits Breakdown -->
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded">
                            <div class="flex items-center">
                                <i class="fas fa-star text-blue-600 mr-2"></i>
                                <span>Featured Listings</span>
                            </div>
                            <span class="font-bold text-blue-600">{{ package.featured_listing_credits }}</span>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-purple-50 rounded">
                            <div class="flex items-center">
                                <i class="fas fa-arrow-up text-purple-600 mr-2"></i>
                                <span>Bump Up Credits</span>
                            </div>
                            <span class="font-bold text-purple-600">{{ package.bump_up_credits }}</span>
                        </div>
                        
                        <div class="flex justify-between items-center p-3 bg-yellow-50 rounded">
                            <div class="flex items-center">
                                <i class="fas fa-highlighter text-yellow-600 mr-2"></i>
                                <span>Highlight Credits</span>
                            </div>
                            <span class="font-bold text-yellow-600">{{ package.highlight_credits }}</span>
                        </div>
                    </div>
                    
                    <!-- Value Calculation -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-600 mb-2">Estimated Value:</div>
                        <div class="flex justify-between items-center">
                            <span>If purchased separately:</span>
                            <span class="font-bold">
                                ₹{{ package.original_price|default:package.price|add:package.price|floatformat:0 }}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Select Button -->
                    <label class="block">
                        <input type="radio" name="package" value="{{ package.id }}" 
                               class="hidden" 
                               {% if forloop.counter == 2 %}checked{% endif %}>
                        <div class="text-center py-3 {% if forloop.counter == 2 %}gradient-bg text-white{% else %}border-2 border-purple-600 text-purple-600{% endif %} rounded-lg cursor-pointer hover:opacity-90 transition font-semibold">
                            {% if forloop.counter == 2 %}
                            <i class="fas fa-bolt mr-2"></i> Buy Now
                            {% else %}
                            Select Package
                            {% endif %}
                        </div>
                    </label>
                </div>
                {% endfor %}
            </div>
            
            <!-- Purchase Summary -->
            <div class="max-w-md mx-auto mt-8 bg-white rounded-xl shadow p-6">
                <h3 class="text-lg font-bold mb-4">Purchase Summary</h3>
                
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Selected Package</span>
                        <span class="font-semibold" id="summary-package">{{ credit_packages.1.name }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Price</span>
                        <span class="font-semibold" id="summary-price">₹{{ credit_packages.1.price|floatformat:0 }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Tax (18% GST)</span>
                        <span class="font-semibold" id="summary-tax">
                            ₹{{ credit_packages.1.price|multiply:0.18|floatformat:0 }}
                        </span>
                    </div>
                    <div class="flex justify-between border-t pt-3 font-bold text-lg">
                        <span>Total</span>
                        <span id="summary-total">
                            ₹{{ credit_packages.1.price|add:credit_packages.1.price|multiply:0.18|floatformat:0 }}
                        </span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex space-x-4">
                    <a href="{% url 'dashboard' %}" 
                       class="flex-1 text-center py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Back to Dashboard
                    </a>
                    <button type="submit" 
                            class="flex-1 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition font-semibold">
                        <i class="fas fa-shopping-cart mr-2"></i> Proceed to Payment
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- How Credits Work -->
    <div class="bg-gray-50 rounded-xl p-8 mb-8">
        <h2 class="text-2xl font-bold mb-6 text-center">How Credits Work</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-star text-blue-600 text-2xl"></i>
                </div>
                <h3 class="font-bold text-lg mb-2">Featured Listings</h3>
                <p class="text-gray-600">
                    Make your property stand out at the top of search results. 
                    Featured listings get 3x more views.
                </p>
            </div>
            
            <div class="text-center">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-arrow-up text-purple-600 text-2xl"></i>
                </div>
                <h3 class="font-bold text-lg mb-2">Bump Up</h3>
                <p class="text-gray-600">
                    Move your property back to the top of search results. 
                    Perfect for renewing interest in older listings.
                </p>
            </div>
            
            <div class="text-center">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-highlighter text-yellow-600 text-2xl"></i>
                </div>
                <h3 class="font-bold text-lg mb-2">Highlight</h3>
                <p class="text-gray-600">
                    Add a colored highlight to your property card. 
                    Makes your listing more noticeable in search results.
                </p>
            </div>
        </div>
    </div>

    <!-- FAQ -->
    <div class="bg-white rounded-xl shadow p-8">
        <h2 class="text-2xl font-bold mb-6">Frequently Asked Questions</h2>
        
        <div class="space-y-6">
            <div>
                <h3 class="font-bold text-lg mb-2">How long do credits last?</h3>
                <p class="text-gray-600">
                    Credits are valid for the duration specified in the package (usually 180-365 days). 
                    Unused credits expire at the end of the validity period.
                </p>
            </div>
            
            <div>
                <h3 class="font-bold text-lg mb-2">Can I share credits with other users?</h3>
                <p class="text-gray-600">
                    No, credits are non-transferable and can only be used by the account that purchased them.
                </p>
            </div>
            
            <div>
                <h3 class="font-bold text-lg mb-2">What happens if I cancel my subscription?</h3>
                <p class="text-gray-600">
                    Your purchased credits remain valid even if you cancel your subscription. 
                    You can continue to use them until they expire.
                </p>
            </div>
            
            <div>
                <h3 class="font-bold text-lg mb-2">Can I get a refund for unused credits?</h3>
                <p class="text-gray-600">
                    Credits are non-refundable. Please use them before they expire.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Package data
    const packages = {
        {% for package in credit_packages %}
        {{ package.id }}: {
            name: "{{ package.name }}",
            price: {{ package.price }},
            originalPrice: {{ package.original_price|default:0 }},
            featured: {{ package.featured_listing_credits }},
            bumpUp: {{ package.bump_up_credits }},
            highlight: {{ package.highlight_credits }},
            discount: {{ package.discount_percentage|default:0 }}
        },
        {% endfor %}
    };

    let selectedPackageId = {% if credit_packages.1 %}{{ credit_packages.1.id }}{% else %}{% if credit_packages.0 %}{{ credit_packages.0.id }}{% endif %}{% endif %};

    // Package selection
    document.querySelectorAll('input[name="package"]').forEach(radio => {
        radio.addEventListener('change', function() {
            selectedPackageId = parseInt(this.value);
            updateSummary();
            
            // Update UI
            document.querySelectorAll('.credit-package').forEach(pkg => {
                pkg.classList.remove('selected');
                const radio = pkg.querySelector('input[type="radio"]');
                if (radio && parseInt(radio.value) === selectedPackageId) {
                    pkg.classList.add('selected');
                }
            });
        });
    });

    function updateSummary() {
        const pkg = packages[selectedPackageId];
        if (!pkg) return;
        
        const tax = pkg.price * 0.18;
        const total = pkg.price + tax;
        
        document.getElementById('summary-package').textContent = pkg.name;
        document.getElementById('summary-price').textContent = `₹${pkg.price.toFixed(0)}`;
        document.getElementById('summary-tax').textContent = `₹${tax.toFixed(0)}`;
        document.getElementById('summary-total').textContent = `₹${total.toFixed(0)}`;
    }

    // Form submission
    document.getElementById('creditForm').addEventListener('submit', function(e) {
        if (!selectedPackageId) {
            e.preventDefault();
            alert('Please select a credit package.');
            return;
        }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Add click handlers to package cards
        document.querySelectorAll('.credit-package').forEach(card => {
            card.addEventListener('click', function(e) {
                if (e.target.type !== 'radio' && e.target.tagName !== 'A') {
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change'));
                    }
                }
            });
        });
        
        updateSummary();
    });
</script>
{% endblock %}